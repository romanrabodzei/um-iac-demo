/*
.Synopsis
    Main Bicep template for data services

.NOTES
    Author     : Roman Rabodzei
    Version    : 1.0.230302

           _
       .__(.)<  (MEOW)
        \___)
~~~~~~~~~~~~~~~~~~~~~~~~
*/

////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////// Deployment scope /////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////

targetScope = 'subscription'

////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////// Parameters and variables ///////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////


var variables = json(loadTextContent('../../parameters/infra.parameters.json'))
// param variables object
param location string

param resourceGroupNameUKS string 
param resourceGroupNameUKW string = ''

param tags object

////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////// Storage accounts /////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////

module storageAccounts 'storage/main.bicep' = {
  name: toLower('storageAccount-${location}-${variables.global.environmentName}')
  params: {
    location: location
    variables: variables
    resourceGroupNameUKS: resourceGroupNameUKS
    resourceGroupNameUKW: resourceGroupNameUKW
    tags: tags
  }
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////// SQL Servers, Databases and Replicas //////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////

module sql 'sql/main.bicep' = {
  name: toLower('sql-${location}-${variables.global.environmentName}')
  params: {
    location: location
    variables: variables
    resourceGroupNameUKS: resourceGroupNameUKS
    resourceGroupNameUKW: resourceGroupNameUKW
    tags: tags
  }
}
